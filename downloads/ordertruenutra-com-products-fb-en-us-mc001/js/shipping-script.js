(()=>{"use strict";var __webpack_modules__={17:(e,t,n)=>{n.d(t,{h:()=>o});var r=n(111);const i="ABConvert";function o(e){const t={source:i,script:e};function n(n,r){const{step:o,message:s,data:a,error:c}=r,p={...t,level:n,step:o,message:s,timestamp:(new Date).toISOString()};void 0!==a&&(p.data=a);const l=function(e){if(e)return e instanceof Error?{message:e.message,stack:e.stack}:"object"==typeof e?e:{value:e}}(c);l&&(p.error=l);const g=function(e){return"error"===e?"error":"warn"===e?"warn":"debug"===e&&"function"==typeof console.debug?"debug":"log"}(n),h=`[${i}] [${e}] [${n.toUpperCase()}]${o?` [${o}]`:""} ${s}`;console[g](h,p)}return{info(e){n("info",e)},warn(e){n("warn",e)},error(e){n("error",e),window.Sentry&&e.error&&(0,r.N)(e.error,{script:t.script,step:e.step,data:e.data})},debug(e){n("debug",e)}}}},111:(e,t,n)=>{function r(){if(window.ABCONVERT_SENTRY_INITIALIZED)return;if(!window.ABCONVERT_SENTRY_DSN)return void console.warn("[ABConvert] ABCONVERT_SENTRY_DSN not configured");const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/@sentry/browser@8/build/bundle.min.js",e.async=!0,e.crossOrigin="anonymous",e.onload=()=>{window.Sentry.init({dsn:window.ABCONVERT_SENTRY_DSN,environment:window.ABCONVERT_ENVIRONMENT||"customer-store",tracesSampleRate:.1,replaysSessionSampleRate:0,replaysOnErrorSampleRate:0,beforeSend:e=>(e.tags=e.tags||{},e.tags.shop_domain=window.Shopify?.shop||"unknown",e.tags.script_version=window.ABCONVERT_SCRIPT_VERSION,e.request&&delete e.request.headers,e)}),window.ABCONVERT_SENTRY_INITIALIZED=!0},e.onerror=()=>{console.error("[ABConvert] Failed to load Sentry SDK from CDN")},document.head.appendChild(e)}function i(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};window.Sentry?window.Sentry.captureException(e,{tags:{script:t.script||"unknown",step:t.step||"unknown"},extra:t.data||{}}):console.error("[ABConvert] Sentry not initialized, cannot report error:",e)}n.d(t,{N:()=>i,i:()=>r})},197:(e,t,n)=>{n.d(t,{$:()=>s,f:()=>o});const r=-1,i=e=>null!=e&&""!==e,o=(e,t,n)=>{let{operator:o,value:a,action:c,groupIndex:p=0}=t;switch(o){case"exists":return i(e)?s({action:c,groupIndex:p}):r;case"not exists":return i(e)?r:s({action:c,groupIndex:p});case"contain":return i(e)&&e.includes(a)?s({action:c,groupIndex:p}):r;case"not contain":return i(e)&&!e.includes(a)?s({action:c,groupIndex:p}):r;case"equal":return e===a?s({action:c,groupIndex:p}):r;case"not equal":return e!==a?s({action:c,groupIndex:p}):r;default:return r}},s=e=>{let{action:t,groupIndex:n=0}=e;switch(t){case"assign-test-group":return n;case"assign-random":return"random";default:return 0}}},533:(e,t,n)=>{n.d(t,{E:()=>r});const r="https://app.abconvert.io"},972:(e,t,n)=>{n.d(t,{N:()=>r});class r{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:()=>{};this.callback=e,this.observeCartChanges(),this.fetchCart().then((e=>{this.cart=e,this.addDiscountedPriceToCart()}))}async fetchCart(){return(await fetch("/cart.js")).json()}async addDiscountedPriceToCart(){const e=this.cart,t=e.items,n=[],r=(window?.Shopify?.routes?.root??"/")+"cart/change.js";for(let i=0;i<t.length;i++){const o=t[i],s=o.final_price??o.price,a=o.properties&&void 0!==o.properties["_abconvert-item-price-presentment"],c=a&&o.properties["_abconvert-item-price-presentment"]!==s;if(!a||c){console.log("[LOG] Updating cart item properties (presentment price)",o);const t={...o.properties||{},"_abconvert-item-price-presentment":s,"_abconvert-presentment-currency":e.currency};n.push(fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({line:i+1,properties:t,quantity:o.quantity})}))}}const i=await Promise.allSettled(n),o=i.filter((e=>"rejected"===e.status));o.length>0&&console.error("[ERROR] Failed to update some cart items:",o.map((e=>e.reason)));const s=i.filter((e=>"fulfilled"===e.status));s.length>0&&console.log(`[LOG] Updated ${s.length} cart items with presentment prices`),window.upcartRefreshCart&&window.upcartRefreshCart()}async emitCartChanges(){const e=await this.fetchCart();this.cart=e;const t=new CustomEvent("abconvert-cart-change",{detail:e,bubbles:!0});window.dispatchEvent(t)}isCartEqual(e,t){const n=e.items.length;if(n!==t.items.length)return!1;for(let r=0;r<n;r++){const n=e.items[r],i=t.items[r];if(!n?.properties?.["_abconvert-session"])return!1;if(n.properties["_abconvert-session"]!==i.properties["_abconvert-session"])return!1}return!0}async observeCartChanges(){new PerformanceObserver((e=>{e.getEntries().forEach((async e=>{const t=["xmlhttprequest","fetch"].includes(e.initiatorType),n=/\/cart\/change/.test(e.name),r=/\/cart\/add/.test(e.name);if(t){if(n){console.log("[ABConvert] Cart change detected");const e=await this.fetchCart();this.isCartEqual(this.cart,e)?console.log("[ABConvert] Cart has not changed, no action taken"):(console.log("[ABConvert] Cart has changed"),this.cart=e,await this.emitCartChanges(),this.callback&&this.callback())}r&&(console.log("[ABConvert] Add to cart"),await this.emitCartChanges(),await this.addDiscountedPriceToCart(),this.callback&&await this.callback())}}))})).observe({entryTypes:["resource"]})}}}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=(e,t)=>{for(var n in t)__webpack_require__.o(t,n)&&!__webpack_require__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={},_services_sentry_browser_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(111),_class_cart_watcher_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(972),_audience_filter_handler_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(197),_config_config_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(533),_helper_logger_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(17);let shopURL,shippingTestData,shippingBannerConfig,sessionId;(0,_services_sentry_browser_js__WEBPACK_IMPORTED_MODULE_1__.i)();const logger=(0,_helper_logger_js__WEBPACK_IMPORTED_MODULE_2__.h)("shipping-test"),SHIPPING_TYPE={FREE_SHIPPING_THRESHOLD:"FREE_SHIPPING_THRESHOLD",FLAT_RATE_SHIPPING:"FLAT_RATE_SHIPPING",ADVANCED_SHIPPING:"ADVANCED_SHIPPING"},cookieExpireTime=2592e6;function uuidV4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}const fetchClient=async function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const r={method:t,mode:"cors",headers:{"Content-Type":"application/json"}};n&&(r.body=JSON.stringify(n));let i=150,o=0;for(;o<3;)try{const t=await fetch(e,r);if(t.ok)return t.json();throw new Error(await t.json())}catch(e){if(i*=2,o+=1,o>=3)throw e;await new Promise((e=>setTimeout(e,i)))}throw new Error("API Error")},getPreviewNumber=()=>{const e=new URLSearchParams(location.search).get("preview");return e&&!isNaN(Number(e))?(window.sessionStorage.setItem("abconvert-preview-number",e),e):window.sessionStorage.getItem("abconvert-preview-number")},getPreviewCountry=()=>{const e=new URLSearchParams(window.location.search).get("country");return e?(window.sessionStorage.setItem("abconvert-preview-country",e),e):window.sessionStorage.getItem("abconvert-preview-country")},getVariant=()=>{const e=localStorage.getItem("abconvert-country"),t=getShippingTestData();return t?t.country!==e?null:t.variant:null},createInput=(e,t)=>{const n=document.createElement("input");return n.type="hidden",n.name=e,n.value=t,n},handleAddToCartSubmit=()=>{const e=document.querySelectorAll('form[action="/cart/add"]'),t=getPreviewNumber(),n=getVariant();let r=getCookie("abconvert-session");e.forEach((e=>{e.insertBefore(createInput("properties[_abconvert-session]",r),e.firstChild),t?e.insertBefore(createInput("properties[_abconvert-shipping-group]",parseInt(t)),e.firstChild):null!=n&&e.insertBefore(createInput("properties[_abconvert-shipping-variant]",n),e.firstChild)}))};async function changeLineItemProperty(){logger.info({step:"line-item-update",message:"Updating line item properties for shipping test"});const e=getPreviewNumber(),t=(window?.Shopify?.routes?.root??"/")+"cart/change.js",n={"Content-Type":"application/json"},r=await fetch((window?.Shopify?.routes?.root??"/")+"cart.js"),i=await r.json();if(logger.debug({step:"line-item-update",message:"Retrieved existing cart",data:{itemCount:i?.items?.length??0}}),!i?.items?.length)return;const o=i.items.length;for(let r=0;r<o;r++){let o=i?.items[r]?.properties??{};if(o["_abconvert-session"]===sessionId)continue;const s=i.items[r].final_price??i.items[r].price,a={line:r+1,properties:{...o,"_abconvert-session":sessionId,"_abconvert-item-price-presentment":s,"_abconvert-presentment-currency":i.currency},quantity:i?.items[r]?.quantity};if(e)a.properties["_abconvert-shipping-group"]=parseInt(e);else{const e=getVariant();a.properties["_abconvert-shipping-variant"]=e}fetch(t,{method:"POST",headers:n,body:JSON.stringify(a)}).then((e=>{e.ok?logger.info({step:"line-item-update",message:"Line item properties updated",data:{line:a.line}}):logger.warn({step:"line-item-update",message:"Failed to update line item properties",data:{line:a.line,status:e.status}}),window.upcartRefreshCart&&window.upcartRefreshCart()}))}}const getCookie=e=>{const t=document.cookie.split("; ").find((t=>t.startsWith(e+"=")));return t?.split("=")[1]||null},loadConfig=async()=>{try{setShopURL(),sessionId=await getOrCreateSessionId(),await fetchShippingConfig(sessionId)}catch(e){logger.error({step:"load-config",message:"Error loading shipping configuration",error:e})}},setShopURL=()=>{if(window.Shopify&&window.Shopify.shop)shopURL=window.Shopify.shop;else{const e=new URLSearchParams(window.location.search);if(shopURL=e.get("shop"),!shopURL)return void logger.error({step:"shop-url",message:"Shop parameter not found in query string"})}localStorage.setItem("shopURL",shopURL)},getOrCreateSessionId=async()=>{if(sessionId=getCookie("abconvert-session"),!sessionId){sessionId="undefined"!=typeof crypto?([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))):uuidV4();const e=new Date(Date.now()+18e5).toUTCString();document.cookie=`abconvert-session=${sessionId}; expires=${e};path=/`,clearStoredData()}return sessionId},clearStoredData=()=>{sessionStorage.removeItem("abconvert-preview-number"),localStorage.removeItem("abconvert-shippingxp"),localStorage.removeItem("abconvert-shipvc"),localStorage.removeItem("abconvert-shipatc"),localStorage.removeItem("abconvert-shipping-banner"),localStorage.removeItem("abconvert-shipcheckout"),document.cookie="abconvert-has-view-shipping-banner=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"},fetchShippingConfig=async sessionId=>{try{const preview=getPreviewNumber(),previewCountry=getPreviewCountry();if(preview){logger.info({step:"fetch-config",message:"Fetching shipping config for preview",data:{preview,previewCountry}});const{shipping,country,customScript=null,isFilteredByCookie=!1,cookieFilterList=[],cookieFilterNotMatchAction=null,testGroups=[]}=await fetchNewConfig(sessionId,preview,previewCountry);return void(shipping&&country?(await updateLocalStorage(shipping,country),customScript&&(logger.info({step:"custom-script",message:"Executing preview shipping custom script"}),eval(customScript)),await getFreeShippingBarConfig()):clearShippingData(country))}shippingTestData=getShippingTestData();const currentTimestamp=Math.floor(Date.now()/1e3);if(shouldFetchNewConfig(shippingTestData,currentTimestamp)){logger.info({step:"fetch-config",message:"Fetching shipping config"});const{shipping,country,customScript=null,isFilteredByCookie=!1,cookieFilterList=[],cookieFilterNotMatchAction=null,testGroups=[]}=await fetchNewConfig(sessionId);if(shipping&&country){if(isFilteredByCookie){let e;logger.debug({step:"cookie-filter",message:"Applying shipping cookie filter"}),e=-1;for(let t=0;t<cookieFilterList.length;t++){const n=cookieFilterList[t],r=n.key,i=getCookie(r);if(e=(0,_audience_filter_handler_js__WEBPACK_IMPORTED_MODULE_0__.f)(i,n,cookieFilterNotMatchAction),-1!=e)break}-1==e&&(e=(0,_audience_filter_handler_js__WEBPACK_IMPORTED_MODULE_0__.$)(cookieFilterNotMatchAction)),"random"!=e&&(logger.info({step:"shipping-variant",message:"Resolved shipping variant for audience filter",data:{groupIndex:e}}),shipping.variant=e,shipping.rate=void 0!==testGroups[e]?.rate?testGroups[e].rate:void 0,shipping.thresholdValue=testGroups[e]?.hasFreeShippingThreshold||testGroups[e]?.hasRateBelowThreshold?testGroups[e].threshold:void 0,shipping.type===SHIPPING_TYPE.ADVANCED_SHIPPING&&(shipping.advancedRates=testGroups[e]?.advancedRates||[]))}await updateLocalStorage(shipping,country),customScript&&(logger.info({step:"custom-script",message:"Executing shipping custom script"}),window.localStorage.setItem("abconvert-shipping-custom-script",customScript),eval(customScript)),await getFreeShippingBarConfig()}else clearShippingData(country)}window.localStorage.getItem("abconvert-shipping-custom-script")&&(logger.info({step:"custom-script",message:"Executing stored shipping custom script"}),eval(window.localStorage.getItem("abconvert-shipping-custom-script")))}catch(e){logger.error({step:"fetch-config",message:"Error fetching the shipping configuration",error:e})}},getShippingTestData=()=>{if(shippingTestData=localStorage.getItem("abconvert-shippingxp"),shippingTestData)try{let e=JSON.parse(shippingTestData);if(e.type===SHIPPING_TYPE.ADVANCED_SHIPPING){let t=null,n=null;for(let r of e.advancedRates)0==r.price&&(n?n>r.minimum&&(n=r.minimum):n=r.minimum),t?t>r.price&&(t=r.price):t=r.price;e.rate=t,e.thresholdValue=n}return e}catch(e){logger.error({step:"parse-config",message:"Error parsing shipping test data",error:e})}return null},shouldFetchNewConfig=(e,t)=>!e||e.expirationTime<t,fetchNewConfig=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const r=localStorage.getItem("abconvert-seed");return await fetchClient(_config_config_js__WEBPACK_IMPORTED_MODULE_3__.E+"/api/shipping/config","POST",{seed:r,shop:shopURL,sessionId:e,previewCountry:n,preview:t})||{}},updateLocalStorage=async(e,t)=>{localStorage.setItem("abconvert-shippingxp",JSON.stringify(e)),localStorage.setItem("abconvert-country",t),e?.seed&&(localStorage.setItem("abconvert-seed",e.seed),changeLineItemProperty())},clearShippingData=e=>{localStorage.setItem("abconvert-shippingxp",""),localStorage.setItem("abconvert-country",e)},getFreeShippingBarConfig=async()=>{const e=await fetchClient(_config_config_js__WEBPACK_IMPORTED_MODULE_3__.E+"/api/public/shipping-banner?shop="+encodeURIComponent(shopURL),"GET");if(e&&!0===e.enable)return localStorage.setItem("abconvert-shipping-banner",JSON.stringify(e)),shippingBannerConfig=e,e;localStorage.removeItem("abconvert-shipping-banner")},createContainer=function(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14;const o=document.createElement("div");return o.classList.add("abconvert-free-shipping-bar"),o.style.backgroundColor=t,o.style.color=n,o.style.padding=`${r}px`,o.style.boxSizing="border-box",o.style.fontSize=`${i}px`,"top"===e?o.style.width="100%":(o.style.position="fixed",o.style.bottom="30px",o.style.left="50%",o.style.minWidth="250px",o.style.transform="translate(-50%, 50%)",o.style.borderRadius="5px",o.style.zIndex="999"),o.style.opacity="1",o.style.transition="opacity 0.5s ease-out",o},createWrapper=(e,t)=>{const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center",n.style.width="100%",n.style.justifyContent="space-between",n.innerHTML=`<span class="abconvert-banner-text"> ${e}</span><button class="abconvert-close-button">&times;</button>`;const r=n.querySelector(".abconvert-close-button"),i=n.querySelector(".abconvert-banner-text");return styleCloseButton(r,t),styleBannerText(i),n},styleBannerText=e=>{e&&(e.style.flexGrow="1",e.style.textAlign="center",e.style.lineHeight="1.5em")},styleCloseButton=(e,t)=>{e&&(e.style.border="none",e.style.background="none",e.style.color="#fff",e.style.fontSize="20px",e.style.cursor="pointer","top"===t&&(e.style.position="absolute"),e.style.right="5px",e.addEventListener("click",(()=>{e.parentElement.parentElement.style.opacity="0",setTimeout((()=>{e.parentElement.parentElement.style.display="none"}),500),document.cookie="abconvert-has-view-shipping-banner=1; expires="+new Date(Date.now()+cookieExpireTime).toUTCString()+"; path=/"})),e.addEventListener("mouseover",(()=>{e.style.opacity="0.5"})),e.addEventListener("mouseout",(()=>{e.style.opacity="1"})))};function getCurrencySymbol(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:e}).format(0).replace(/[\d.,\s]+/g,"")}const renderFreeShippingBar=async()=>{const e=new URLSearchParams(window.location.search);let t,n,r,i,o,s;if(e.get("isShippingBannerPreview"))t=e.get("backgroundColor")||"#333",n=e.get("textColor")||"#333",r=e.get("text")||"This is a floating bar",i=e.get("position")||"bottom",o=e.get("fontSize")||14,s=e.get("padding")||10;else{if(shippingTestData=getShippingTestData(),!shippingTestData)return;if("1"===getCookie("abconvert-has-view-shipping-banner"))return;if(shippingBannerConfig=JSON.parse(localStorage.getItem("abconvert-shipping-banner")),!shippingBannerConfig)return;t=shippingBannerConfig.bannerBackgroundColor,n=shippingBannerConfig.bannerTextColor,i=shippingBannerConfig.position,o=shippingBannerConfig.fontSize,s=shippingBannerConfig.padding;const{type:e,thresholdValue:a="",rate:c,currency:p}=shippingTestData,{rate:l,active:g}=window?.Shopify?.currency||{},h=getCurrencySymbol(g),u=window?.Shopify?.country;let d,_;if(p&&p==g?(_=c,d=a):(_=l&&c?c*l:0,d=l&&a?a*l:0),e===SHIPPING_TYPE.FREE_SHIPPING_THRESHOLD)r=0===a?shippingBannerConfig.bannerText.freeShipping:shippingBannerConfig.bannerText.freeShippingThreshold;else if(e===SHIPPING_TYPE.FLAT_RATE_SHIPPING)r=a?shippingBannerConfig.bannerText.freeShippingThreshold:shippingBannerConfig.bannerText.flatRateNoFreeShippingThreshold;else{if(e!==SHIPPING_TYPE.ADVANCED_SHIPPING)return;r=0===a?shippingBannerConfig.bannerText.freeShipping:a?shippingBannerConfig.bannerText.freeShippingThreshold:shippingBannerConfig.bannerText.flatRateNoFreeShippingThreshold}if(r.includes("{threshold}")){const e=(d/100).toFixed(2);r=r.replace("{threshold}",`${h}${e}`)}if(r.includes("{shipping_rate}")){const e=(_/100).toFixed(2);r=r.replace("{shipping_rate}",`${h}${e}`)}r.includes("{country}")&&(r=r.replace("{country}",u||"")),r.includes("{currency_code}")&&(r=r.replace("{currency_code}",g||""))}const a=createContainer(i,t,n,s,o),c=createWrapper(r,i);if(a.appendChild(c),"top"===i){const e=document.getElementById("abconvert-shipping"),t=document.getElementById("shopify-section-header"),n=document.getElementsByClassName("section-header")[0];e?e.prepend(a):t?t.prepend(a):n&&n.prepend(a)}else document.body.appendChild(a)};function formatShippingNumber(e){const t=e/100;return Number.isInteger(t)?t:t.toFixed(2)}const emitEvent=(e,t)=>{const n=new CustomEvent(e,{detail:t});document.dispatchEvent(n)},postInitEvent=()=>{emitEvent("abconvert:shipping:initialized",{shippingTestData})},initialize=async()=>{logger.info({step:"init",message:"Initializing shipping script"}),await Promise.all([setShopURL(),getOrCreateSessionId().then((e=>fetchShippingConfig(e))).then((()=>{const e=!!localStorage.getItem("abconvert-shippingxp");renderFreeShippingBar(),e&&(postInitEvent(),handleAddToCartSubmit(),changeLineItemProperty(),window.cartWatcher=new _class_cart_watcher_js__WEBPACK_IMPORTED_MODULE_4__.N(changeLineItemProperty))}))])};logger.info({step:"init",message:"Running ABConvert shipping script production: 5.1.0 - use final_price for accurate presentment pricing with discounts"}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initialize):initialize()})();