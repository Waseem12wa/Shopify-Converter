(function(){function R(){return window.location.search.includes("jdgm_debug=true")}const b=R();function a(...e){b&&console.log(...e)}window.jdgm=window.jdgm||{},window.jdgm.debugLog=a;async function _(){const e=window.jdgm?.CDN_HOST,t=window.jdgm?.CDN_HOST_ALT,n=window.jdgm?.API_HOST,l=window.Shopify?.shop;if(!e){a("[Judge.me Widget Loader] CDN_HOST not configured, skipping CDN test");return}if(t&&e===t){a("[Judge.me Widget Loader] Using alternative CDN as primary, skipping CDN test");return}if(!l){a("[Judge.me Widget Loader] Shopify shop not found, skipping CDN test");return}const d=`${e}installed.js`;a("[Judge.me Widget Loader] Testing CDN reachability:",d);function s(g){if(a("[Judge.me Widget Loader] ‚ùå CDN test failed, reporting to API"),!n){a("[Judge.me Widget Loader] API_HOST not configured, cannot report CDN failure");return}const i=`${n}api/widget/requests`;fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({shop_domain:l,method:"HEAD",url:d,status:g,duration:0})}).then(()=>{a("[Judge.me Widget Loader] ‚úÖ CDN failure reported to API")}).catch(c=>{a("[Judge.me Widget Loader] ‚ö†Ô∏è Failed to report CDN failure:",c.message)})}const o=new XMLHttpRequest;o.open("HEAD",d,!0),o.timeout=15e3,o.onload=()=>{o.status>=200&&o.status<400?a("[Judge.me Widget Loader] ‚úÖ CDN test successful"):s(o.status)},o.onerror=()=>{s(-1)},o.ontimeout=()=>{s(0)},o.send()}_(),a("[Judge.me Widget Loader] Script loaded and executing...");const L=".jdgm-widget[data-entry-point]",f=document.querySelectorAll(L);if(f.length===0){a("[Judge.me Widget Loader] No containers found with selector:",L);return}a("[Judge.me Widget Loader] Found "+f.length+" container(s), processing each...");const h=new Set,r={REVIEW:"review",ALL_REVIEWS_V2025:"all-reviews-v2025",CAROUSEL:"carousel",TRUST_BADGE:"trust-badge",STORE_SUMMARY:"store-summary"},C={review:r.REVIEW,"all-reviews-v2025":r.ALL_REVIEWS_V2025,"testimonials-carousel":r.CAROUSEL,"cards-carousel":r.CAROUSEL,"videos-carousel":r.CAROUSEL,"trust-badge":r.TRUST_BADGE,"store-summary":r.STORE_SUMMARY};function D(e){const t=e.dataset.widget;return C[t]||null}function A(e){const t=e.querySelector(".jdgm-legacy-widget-content");return t?t.innerHTML.trim().length>20:!1}function J(e,t){if(t===r.ALL_REVIEWS_V2025){const d=window.jdgm?.data?.allReviewsWidgetV2025;return!!(d&&Object.keys(d).length>0)}const n=e.dataset.productId,l=window.jdgm?.data?.reviewWidget?.[n];return!!(l&&l.reviews!==void 0)}function v(e,t,n){const l=window.jdgmSettings?.[t],d=e.dataset.productId,s=A(e),o=J(e,n);let g=null,i="",c="",u=!1;return l?o?(u=!0,s?(g=1,i="Revamp enabled + both data sources available",c="Loading revamp widget (preferred)"):(g=3,i="Revamp enabled + only revamp data",c="Loading revamp widget (only option available)")):s?(g=2,i="Revamp enabled + only legacy data",c="Falling back to legacy widget (revamp data not available)",u=!1):(g="edge-revamp-no-data",i="Revamp enabled + no data sources",c="Loading revamp widget for empty state",u=!0):s?(u=!1,o?(g=4,i="Revamp disabled + both data sources available",c="Showing legacy widget (preferred)"):(g=6,i="Revamp disabled + only legacy data",c="Showing legacy widget (only option available)")):o?(g=5,i="Revamp disabled + only revamp data",c="Falling back to revamp widget (legacy not available)",u=!0):(g="edge-no-data",i="Revamp disabled + no data sources",c="No widget will be shown (no data available)",u=!1),{scenarioId:g,scenarioName:i,decision:c,shouldLoadRevamp:u,metadata:{productId:d,revampEnabled:l,hasLegacyData:s,hasRevampData:o}}}function E(e,t,n,l){a("[Judge.me Widget Loader] "+n+" - Scenario "+t.scenarioId+": "+t.scenarioName),a("[Judge.me Widget Loader] "+n+" - Decision:",t.decision),a("[Judge.me Widget Loader] "+n+" - Debug info:",{...t.metadata,willLoadRevamp:t.shouldLoadRevamp});let d;l===r.ALL_REVIEWS_V2025?d=window.jdgm?.data?.allReviewsWidgetV2025:d=window.jdgm?.data?.reviewWidget?.[t.metadata.productId];const s=!!d;t.metadata.hasRevampData!==s&&(console.warn("[Judge.me Widget Loader] ‚ö†Ô∏è Data mismatch detected!!"),console.warn("[Judge.me Widget Loader] Liquid says hasRevamp:",t.metadata.hasRevampData),console.warn("[Judge.me Widget Loader] JavaScript sees data:",s),console.warn("[Judge.me Widget Loader] Actual data:",d));const o=e.querySelector(".jdgm-legacy-widget-content");if(o){const g=o.innerHTML.trim().length;if(g>0&&g<=20){const i=o.innerHTML.trim().substring(0,50);a("[Judge.me Widget Loader] üìè Legacy widget is small ("+g+' chars), treating as empty. Content: "'+i+'"')}}}function S(e){const t=e.querySelector(".jdgm-legacy-widget-content");t&&(t.style.display=""),a("[Judge.me Widget Loader] ‚úÖ Legacy widget displayed")}function p(e){const t=e.dataset.entryPoint,n=e.dataset.entryKey;if(!t||!n){a("[Judge.me Widget Loader] ‚ö†Ô∏è Missing entryPoint or entryKey, skipping container");return}const l=window.jdgm.CDN_BASE_URL,d=l+t,s=e.querySelector(".jdgm-rev-widg");if(s&&(s.style.display="none",a("[Judge.me Widget Loader] üôà Hidden legacy widget element (.jdgm-rev-widg)")),a("[Judge.me Widget Loader] ‚è≥ Loading revamp widget:",t),h.has(d)||document.querySelector('script[src="'+d+'"]')){a("[Judge.me Widget Loader] ‚è≠Ô∏è Script already loaded, skipping:",t);return}h.add(d),T(l,n,t).finally(()=>{const o=document.createElement("script");o.type="module",o.src=d,o.onload=()=>{a("[Judge.me Widget Loader] ‚úÖ Revamp widget script loaded successfully:",t)},o.onerror=()=>{console.error("[Judge.me Widget Loader] ‚ùå Failed to load revamp widget script:",t)},document.head.appendChild(o)})}async function T(e,t,n){if(!(e+n).includes("localhost"))try{let c=function(u){const m=g[u];m&&(m.css&&m.css.forEach(w=>{const W=e+w;if(!document.querySelector('link[href="'+W+'"]')){const y=document.createElement("link");y.rel="stylesheet",y.href=W,document.head.appendChild(y)}}),m.imports&&m.imports.forEach(c))};var d=c;const s=e+"manifest.json?v="+Date.now(),g=await(await fetch(s)).json(),i=g[t];i&&i.css&&i.css.forEach(u=>{const m=e+u;if(!document.querySelector('link[href="'+m+'"]')){const w=document.createElement("link");w.rel="stylesheet",w.href=m,document.head.appendChild(w)}}),i&&i.imports&&i.imports.forEach(c)}catch(s){console.warn("Could not load manifest or CSS files:",s)}}f.forEach((e,t)=>{const n=D(e),l=e.dataset.entryPoint;if(a("[Judge.me Widget Loader] Processing container "+(t+1)+"/"+f.length+" - Type: "+n+", Entry: "+l),!n){a("[Judge.me Widget Loader] ‚è≠Ô∏è Unknown widget type, skipping container");return}switch(n){case r.REVIEW:{const d=v(e,"review_widget_revamp_enabled",r.REVIEW);E(e,d,"Review Widget",r.REVIEW),d.shouldLoadRevamp?p(e):S(e);break}case r.ALL_REVIEWS_V2025:{const d=v(e,"all_reviews_widget_v2025_enabled",r.ALL_REVIEWS_V2025);E(e,d,"All Reviews V2025 Widget",r.ALL_REVIEWS_V2025),d.shouldLoadRevamp?p(e):S(e);break}case r.CAROUSEL:a("[Judge.me Widget Loader] Carousel widget - always loading revamp"),p(e);break;case r.TRUST_BADGE:{a("[Judge.me Widget Loader] Trust Badge widget"),p(e);break}case r.STORE_SUMMARY:{a("[Judge.me Widget Loader] Store Summary widget"),p(e);break}}})})();
