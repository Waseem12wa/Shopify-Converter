(function(){function R(){return window.location.search.includes("jdgm_debug=true")}const b=R();function a(...e){b&&console.log(...e)}window.jdgm=window.jdgm||{},window.jdgm.debugLog=a;async function _(){const e=window.jdgm?.CDN_HOST,t=window.jdgm?.API_HOST,n=window.Shopify?.shop;if(!e){a("[Judge.me Widget Loader] CDN_HOST not configured, skipping CDN test");return}if(!n){a("[Judge.me Widget Loader] Shopify shop not found, skipping CDN test");return}const l=`${e}installed.js`;a("[Judge.me Widget Loader] Testing CDN reachability:",l);function d(g){if(a("[Judge.me Widget Loader] ‚ùå CDN test failed, reporting to API"),!t){a("[Judge.me Widget Loader] API_HOST not configured, cannot report CDN failure");return}const s=`${t}api/widget/requests`;fetch(s,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({shop_domain:n,method:"HEAD",url:l,status:g,duration:0})}).then(()=>{a("[Judge.me Widget Loader] ‚úÖ CDN failure reported to API")}).catch(i=>{a("[Judge.me Widget Loader] ‚ö†Ô∏è Failed to report CDN failure:",i.message)})}const o=new XMLHttpRequest;o.open("HEAD",l,!0),o.timeout=15e3,o.onload=()=>{o.status>=200&&o.status<400?a("[Judge.me Widget Loader] ‚úÖ CDN test successful"):d(o.status)},o.onerror=()=>{d(-1)},o.ontimeout=()=>{d(0)},o.send()}_(),a("[Judge.me Widget Loader] Script loaded and executing...");const L=".jdgm-widget[data-entry-point]",f=document.querySelectorAll(L);if(f.length===0){a("[Judge.me Widget Loader] No containers found with selector:",L);return}a("[Judge.me Widget Loader] Found "+f.length+" container(s), processing each...");const h=new Set,r={REVIEW:"review",ALL_REVIEWS_V2025:"all-reviews-v2025",CAROUSEL:"carousel",TRUST_BADGE:"trust-badge",STORE_SUMMARY:"store-summary"},C={review:r.REVIEW,"all-reviews-v2025":r.ALL_REVIEWS_V2025,"testimonials-carousel":r.CAROUSEL,"cards-carousel":r.CAROUSEL,"videos-carousel":r.CAROUSEL,"trust-badge":r.TRUST_BADGE,"store-summary":r.STORE_SUMMARY};function D(e){const t=e.dataset.widget;return C[t]||null}function A(e){const t=e.querySelector(".jdgm-legacy-widget-content");return t?t.innerHTML.trim().length>20:!1}function J(e,t){if(t===r.ALL_REVIEWS_V2025){const d=window.jdgm?.data?.allReviewsWidgetV2025;return!!(d&&Object.keys(d).length>0)}const n=e.dataset.productId,l=window.jdgm?.data?.reviewWidget?.[n];return!!(l&&l.reviews!==void 0)}function v(e,t,n){const l=window.jdgmSettings?.[t],d=e.dataset.productId,o=A(e),g=J(e,n);let s=null,i="",c="",u=!1;return l?g?(u=!0,o?(s=1,i="Revamp enabled + both data sources available",c="Loading revamp widget (preferred)"):(s=3,i="Revamp enabled + only revamp data",c="Loading revamp widget (only option available)")):o?(s=2,i="Revamp enabled + only legacy data",c="Falling back to legacy widget (revamp data not available)",u=!1):(s="edge-revamp-no-data",i="Revamp enabled + no data sources",c="Loading revamp widget for empty state",u=!0):o?(u=!1,g?(s=4,i="Revamp disabled + both data sources available",c="Showing legacy widget (preferred)"):(s=6,i="Revamp disabled + only legacy data",c="Showing legacy widget (only option available)")):g?(s=5,i="Revamp disabled + only revamp data",c="Falling back to revamp widget (legacy not available)",u=!0):(s="edge-no-data",i="Revamp disabled + no data sources",c="No widget will be shown (no data available)",u=!1),{scenarioId:s,scenarioName:i,decision:c,shouldLoadRevamp:u,metadata:{productId:d,revampEnabled:l,hasLegacyData:o,hasRevampData:g}}}function E(e,t,n,l){a("[Judge.me Widget Loader] "+n+" - Scenario "+t.scenarioId+": "+t.scenarioName),a("[Judge.me Widget Loader] "+n+" - Decision:",t.decision),a("[Judge.me Widget Loader] "+n+" - Debug info:",{...t.metadata,willLoadRevamp:t.shouldLoadRevamp});let d;l===r.ALL_REVIEWS_V2025?d=window.jdgm?.data?.allReviewsWidgetV2025:d=window.jdgm?.data?.reviewWidget?.[t.metadata.productId];const o=!!d;t.metadata.hasRevampData!==o&&(console.warn("[Judge.me Widget Loader] ‚ö†Ô∏è Data mismatch detected!!"),console.warn("[Judge.me Widget Loader] Liquid says hasRevamp:",t.metadata.hasRevampData),console.warn("[Judge.me Widget Loader] JavaScript sees data:",o),console.warn("[Judge.me Widget Loader] Actual data:",d));const g=e.querySelector(".jdgm-legacy-widget-content");if(g){const s=g.innerHTML.trim().length;if(s>0&&s<=20){const i=g.innerHTML.trim().substring(0,50);a("[Judge.me Widget Loader] üìè Legacy widget is small ("+s+' chars), treating as empty. Content: "'+i+'"')}}}function S(e){const t=e.querySelector(".jdgm-legacy-widget-content");t&&(t.style.display=""),a("[Judge.me Widget Loader] ‚úÖ Legacy widget displayed")}function p(e){const t=e.dataset.entryPoint,n=e.dataset.entryKey;if(!t||!n){a("[Judge.me Widget Loader] ‚ö†Ô∏è Missing entryPoint or entryKey, skipping container");return}const l=window.jdgm.CDN_BASE_URL,d=l+t,o=e.querySelector(".jdgm-rev-widg");if(o&&(o.style.display="none",a("[Judge.me Widget Loader] üôà Hidden legacy widget element (.jdgm-rev-widg)")),a("[Judge.me Widget Loader] ‚è≥ Loading revamp widget:",t),h.has(d)||document.querySelector('script[src="'+d+'"]')){a("[Judge.me Widget Loader] ‚è≠Ô∏è Script already loaded, skipping:",t);return}h.add(d),T(l,n,t).finally(()=>{const g=document.createElement("script");g.type="module",g.src=d,g.onload=()=>{a("[Judge.me Widget Loader] ‚úÖ Revamp widget script loaded successfully:",t)},g.onerror=()=>{console.error("[Judge.me Widget Loader] ‚ùå Failed to load revamp widget script:",t)},document.head.appendChild(g)})}async function T(e,t,n){if(!(e+n).includes("localhost"))try{let c=function(u){const m=s[u];m&&(m.css&&m.css.forEach(w=>{const W=e+w;if(!document.querySelector('link[href="'+W+'"]')){const y=document.createElement("link");y.rel="stylesheet",y.href=W,document.head.appendChild(y)}}),m.imports&&m.imports.forEach(c))};var d=c;const o=e+"manifest.json?v="+Date.now(),s=await(await fetch(o)).json(),i=s[t];i&&i.css&&i.css.forEach(u=>{const m=e+u;if(!document.querySelector('link[href="'+m+'"]')){const w=document.createElement("link");w.rel="stylesheet",w.href=m,document.head.appendChild(w)}}),i&&i.imports&&i.imports.forEach(c)}catch(o){console.warn("Could not load manifest or CSS files:",o)}}f.forEach((e,t)=>{const n=D(e),l=e.dataset.entryPoint;if(a("[Judge.me Widget Loader] Processing container "+(t+1)+"/"+f.length+" - Type: "+n+", Entry: "+l),!n){a("[Judge.me Widget Loader] ‚è≠Ô∏è Unknown widget type, skipping container");return}switch(n){case r.REVIEW:{const d=v(e,"review_widget_revamp_enabled",r.REVIEW);E(e,d,"Review Widget",r.REVIEW),d.shouldLoadRevamp?p(e):S(e);break}case r.ALL_REVIEWS_V2025:{const d=v(e,"all_reviews_widget_v2025_enabled",r.ALL_REVIEWS_V2025);E(e,d,"All Reviews V2025 Widget",r.ALL_REVIEWS_V2025),d.shouldLoadRevamp?p(e):S(e);break}case r.CAROUSEL:a("[Judge.me Widget Loader] Carousel widget - always loading revamp"),p(e);break;case r.TRUST_BADGE:{a("[Judge.me Widget Loader] Trust Badge widget"),p(e);break}case r.STORE_SUMMARY:{a("[Judge.me Widget Loader] Store Summary widget"),p(e);break}}})})();
